# Default values for the sms-checker Helm chart.
# These can be overridden at install time with --values or --set.

app:
  image:
    repository: "ghcr.io/doda25-team11/app"
    tag: "0.latest"
    tagStable: "0.latest"
    tagCanary: "0.latest"
  replicaCount: 1

modelService:
  image:
    repository: "ghcr.io/doda25-team11/model-service"
    tag: "latest"
    tagStable: "latest"
    tagCanary: "latest"
  replicaCount: 1

  servicePort: 80
  serviceNameOverride: ""
  modelVersionTag: "model-20251118-102052"

imagePullSecrets:
  - name: ghcr-credentials

ingress:
  enabled: false              # Should be turned to true later
  className: ""
  host: "sms-checker.local"  # placeholder, will be overridden per cluster
  annotations: {}

# Istio traffic management config
istio:
  enabled: true
  ingressGateway:
    selectorLabels:
      istio: ingressgateway

  # Hostname that users will use for the app (configure /etc/hosts to point it to the IngressGateway IP)
  hosts:
    app: sms.local

  trafficSplit:
    stableWeight: 90
    canaryWeight: 10

  # Sticky session header â€“ used to force users into v1 or v2
  stickyHeader: x-doda-exp

  # Shadow launch (traffic mirroring) for the model service
  mirroring:
    enabled: true
    percentage: 100.0

# Prometheus metrics ingress
metricsIngress:
  enabled: true
  host: sms.local
  className: nginx
  annotations: {}

# Prometheus Operator (kube-prometheus-stack) configuration overrides
myprom:
  # Exclude admission webhook jobs from sidecar injection
  prometheusOperator:
    admissionWebhooks:
      patch:
        podAnnotations:
          sidecar.istio.io/inject: "false"
  
  # Exclude monitoring components
  kube-state-metrics:
    podAnnotations:
      sidecar.istio.io/inject: "false"
  
  prometheus-node-exporter:
    podAnnotations:
      sidecar.istio.io/inject: "false"
  
  prometheus:
    prometheusSpec:
      podMetadata:
        annotations:
          sidecar.istio.io/inject: "false"

  alertmanager:
    alertmanagerSpec:
      secrets:
        - alertmanager-discord-webhook
    config:
      route:
        receiver: discord
        group_by: ['alertname', 'cluster', 'service']
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 3h
        routes: []
      receivers:
        - name: discord
          slack_configs:
            - api_url_file: /etc/alertmanager/secrets/alertmanager-discord-webhook/webhook_url
              send_resolved: true
              title: "{{ .CommonAnnotations.summary }}"
              text: "{{ range .Alerts }}*[{{ .Status | toUpper }}]* {{ .Annotations.description }} ({{ .Labels.severity }})\n{{ end }}"
        - name: "null"
  grafana:
    grafana.ini:
      server:
        root_url: http://sms.local/grafana/
        serve_from_sub_path: true
    sidecar:
      dashboards:
        enabled: true

grafanaIngress:
  enabled: true
  host: sms.local
  className: nginx
  annotations: {}
